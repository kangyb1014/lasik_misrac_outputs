{
  "user_message": "An agent A claimed that the following run_usock code violates the MISRA C 2023 rule 8.13.\n<misra_rule>\nMISRA C 2023 Rule 8.13 is A pointer should point to a const-qualified type whenever possible.\n\n</misra_rule>\n<target_code>\nHere is the original code of run_usock.\n```c\nstatic void *\nrun_usock (void *cls)\n{\n  struct WsData *ws = cls;\n  struct MHD_UpgradeResponseHandle *urh = ws->urh;\n  unsigned char buf[2048];\n  unsigned char *msg;\n  char *text;\n  ssize_t got;\n  int type;\n  int i;\n\n  make_blocking (ws->sock);\n  while (1)\n  {\n    got = recv (ws->sock, (void *) buf, sizeof (buf), 0);\n    if (0 >= got)\n    {\n      break;\n    }\n    msg = ws_receive_frame (buf, &got, &type);\n    if (NULL == msg)\n    {\n      break;\n    }\n    if (type == WS_OPCODE_TEXT_FRAME)\n    {\n      ssize_t sent;\n      int buf_size;\n      buf_size = snprintf (NULL, 0, \"User#%d: %s\", (int) ws->sock, msg);\n      if (0 < buf_size)\n      {\n        text = malloc ((size_t) buf_size + 1);\n        if (NULL != text)\n        {\n          if (snprintf (text, (size_t) buf_size + 1,\n                        \"User#%d: %s\", (int) ws->sock, msg) == buf_size)\n            sent = ws_send_frame (ws->sock, text, (size_t) buf_size);\n          else\n            sent = -1;\n          free (text);\n        }\n        else\n          sent = -1;\n      }\n      else\n        sent = -1;\n      free (msg);\n      if (-1 == sent)\n      {\n        break;\n      }\n    }\n    else\n    {\n      if (type == WS_OPCODE_CON_CLOSE_FRAME)\n      {\n        free (msg);\n        break;\n      }\n    }\n  }\n  if (0 != pthread_mutex_lock (&MUTEX))\n    abort ();\n  for (i = 0; i < MAX_CLIENTS; i++)\n  {\n    if (CLIENT_SOCKS[i] == ws->sock)\n    {\n      CLIENT_SOCKS[i] = MHD_INVALID_SOCKET;\n      break;\n    }\n  }\n  if (0 != pthread_mutex_unlock (&MUTEX))\n    abort ();\n  free (ws);\n  MHD_upgrade_action (urh, MHD_UPGRADE_ACTION_CLOSE);\n  return NULL;\n}\n```\n</target_code>\n<response format>\nProvide your answer with these fields.\n- explanation: your evaluation of the scenario provided by the agent A.\n- is_report_correct: whether the report is correct or not (true/false). True means there is a violation.\n</response format>\n<scenario>\nThe agent A provided the following violation scenario:\nThis fragment can violate Rule 8.13 if the prototype of ws_send_frame does not use a const-qualified pointer. For example, if ws_send_frame is declared as\n\n  int ws_send_frame(MHD_socket sock, char *data, size_t len);\n\nand the function only reads/sends the buffer (does not modify it), then the second parameter should be declared const char *data. In that case passing the non-const char *text here reveals a violation of MISRA C 2023 Rule 8.13. (If ws_send_frame is already declared as taking const char *data, then there is no violation.)\n</scenario>\n<additional code>Here are the definitions of symbols that are close to the target function run_usock:\nstruct WsData\n{\n  struct MHD_UpgradeResponseHandle *urh;\n  MHD_socket sock;\n}\n...\nstruct MHD_UpgradeResponseHandle\n</additional code>\n\n<instruction>\nJudge whether the report is correct or not.\n</instruction>\n",
  "is_report_correct": false,
  "explanation": "MISRA C:2023 Rule 8.13 concerns the declarations of pointer types (they should be const-qualified where possible). The run_usock function itself does not violate that rule: the pointers inside run_usock (e.g. text, msg, ws) refer to buffers that the function allocates or modifies (text is filled by snprintf, msg is freed), so they are correctly non-const. The only way the scenario described would indicate a Rule 8.13 problem is if the prototype of ws_send_frame is incorrectly declared as taking a non-const pointer even though it only reads the buffer. In that case the violation is in the declaration of ws_send_frame (its prototype should use const char * if it does not modify the data), not in run_usock. Also, passing a non-const char * to a parameter declared const char * is not a Rule 8.13 violation. Therefore the agent's conditional observation (that a non-const prototype for ws_send_frame would be non-compliant) is correct in principle, but the report that run_usock itself violates Rule 8.13 is not correct."
}