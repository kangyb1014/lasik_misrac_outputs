{
  "user_message": "An agent A claimed that the following file_reader code violates the MISRA C 2023 rule 17.8.\n<misra_rule>\nMISRA C 2023 Rule 17.8 is A function parameter should not be modified.\nNote that the object referred to by a pointer parameter may be modified, but the pointer itself shall not be modified..\n</misra_rule>\n<target_code>\nHere is the original code of file_reader.\n```c\nstatic ssize_t\nfile_reader (void *cls,\n             uint64_t pos,\n             char *buf,\n             size_t max)\n{\n  struct MHD_Response *response = cls;\n#if ! defined(_WIN32) || defined(__CYGWIN__)\n  ssize_t n;\n#else  /* _WIN32 && !__CYGWIN__ */\n  const HANDLE fh = (HANDLE) (uintptr_t) _get_osfhandle (response->fd);\n#endif /* _WIN32 && !__CYGWIN__ */\n  const int64_t offset64 = (int64_t) (pos + response->fd_off);\n\n  if (offset64 < 0)\n    return MHD_CONTENT_READER_END_WITH_ERROR; /* seek to required position is not possible */\n\n#if ! defined(_WIN32) || defined(__CYGWIN__)\n  if (max > SSIZE_MAX)\n    max = SSIZE_MAX; /* Clamp to maximum return value. */\n\n#if defined(HAVE_PREAD64)\n  n = pread64 (response->fd, buf, max, offset64);\n#elif defined(HAVE_PREAD)\n  if ( (sizeof(off_t) < sizeof (uint64_t)) &&\n       (offset64 > (uint64_t) INT32_MAX) )\n    return MHD_CONTENT_READER_END_WITH_ERROR; /* Read at required position is not possible. */\n\n  n = pread (response->fd, buf, max, (off_t) offset64);\n#else  /* ! HAVE_PREAD */\n#if defined(HAVE_LSEEK64)\n  if (lseek64 (response->fd,\n               offset64,\n               SEEK_SET) != offset64)\n    return MHD_CONTENT_READER_END_WITH_ERROR; /* can't seek to required position */\n#else  /* ! HAVE_LSEEK64 */\n  if ( (sizeof(off_t) < sizeof (uint64_t)) &&\n       (offset64 > (uint64_t) INT32_MAX) )\n    return MHD_CONTENT_READER_END_WITH_ERROR; /* seek to required position is not possible */\n\n  if (lseek (response->fd,\n             (off_t) offset64,\n             SEEK_SET) != (off_t) offset64)\n    return MHD_CONTENT_READER_END_WITH_ERROR; /* can't seek to required position */\n#endif /* ! HAVE_LSEEK64 */\n  n = read (response->fd,\n            buf,\n            max);\n\n#endif /* ! HAVE_PREAD */\n  if (0 == n)\n    return MHD_CONTENT_READER_END_OF_STREAM;\n  if (n < 0)\n    return MHD_CONTENT_READER_END_WITH_ERROR;\n  return n;\n#else /* _WIN32 && !__CYGWIN__ */\n  if (INVALID_HANDLE_VALUE == fh)\n    return MHD_CONTENT_READER_END_WITH_ERROR; /* Value of 'response->fd' is not valid. */\n  else\n  {\n    OVERLAPPED f_ol = {0, 0, {{0, 0}}, 0};   /* Initialize to zero. */\n    ULARGE_INTEGER pos_uli;\n    DWORD toRead = (max > INT32_MAX) ? INT32_MAX : (DWORD) max;\n    DWORD resRead;\n\n    pos_uli.QuadPart = (uint64_t) offset64;   /* Simple transformation 64bit -> 2x32bit. */\n    f_ol.Offset = pos_uli.LowPart;\n    f_ol.OffsetHigh = pos_uli.HighPart;\n    if (! ReadFile (fh, (void *) buf, toRead, &resRead, &f_ol))\n      return MHD_CONTENT_READER_END_WITH_ERROR;   /* Read error. */\n    if (0 == resRead)\n      return MHD_CONTENT_READER_END_OF_STREAM;\n    return (ssize_t) resRead;\n  }\n#endif /* _WIN32 && !__CYGWIN__ */\n}\n```\n</target_code>\n<scenario>\nThe agent A provided the following violation scenario:The function modifies its scalar parameter 'max' inside file_reader: the line 'if (max > SSIZE_MAX) max = SSIZE_MAX;' assigns to the parameter 'max', which violates MISRA C 2023 Rule 17.8 (a function parameter shall not be modified).\n</scenario>\n<test_code>\nAlso, the agent A provided the following modified code that prints out the log to support their scenario:\n```c\nstatic const ssize_t CR_END_WITH_ERROR = -1;\nstatic const ssize_t CR_END_OF_STREAM = 0;\nstatic void log_state(const char *stage, uint64_t pos, size_t max, int code)\n{\n  FILE *f = fopen(\"/tmp/logs/621.txt\", \"a\");\n  if (f != NULL)\n  {\n    /* stage: textual description, pos: requested position, max: byte count, code: branch id */\n    fprintf(f, \"%s: pos=%\" PRIu64 \", max=%zu, branch=%d\\n\", stage, pos, max, code);\n    (void) fclose(f);\n  }\n}\n\nstatic ssize_t\nfile_reader (void *cls,\n             uint64_t pos,\n             char *buf,\n             size_t max)\n{\n  struct MHD_Response *response = cls;\n  ssize_t n;\n  const int64_t offset64 = (int64_t) (pos + response->fd_off);\n\n  /* Log entry state */\n  log_state(\"entry\", pos, max, 0);\n\n  if (offset64 < 0)\n  {\n    log_state(\"offset_negative\", pos, max, 1);\n    return CR_END_WITH_ERROR; /* seek to required position is not possible */\n  }\n\n  if (max > SSIZE_MAX)\n  {\n    /* This assignment modifies the parameter 'max' (violation of MISRA C 2023 Rule 17.8). */\n    max = SSIZE_MAX; /* Clamp to maximum return value. */\n    log_state(\"clamped_max\", pos, max, 2);\n  }\n\n  /* Attempt seek and read using lseek/read as a generic POSIX path. The logic\n     is preserved from the original implementation. */\n#if defined(HAVE_LSEEK64)\n  if (lseek64 (response->fd,\n               offset64,\n               SEEK_SET) != offset64)\n  {\n    log_state(\"lseek64_fail\", pos, max, 3);\n    return CR_END_WITH_ERROR; /* can't seek to required position */\n  }\n#else\n  if ( (sizeof(off_t) < sizeof (uint64_t)) &&\n       (offset64 > (uint64_t) INT32_MAX) )\n  {\n    log_state(\"seek_overflow\", pos, max, 4);\n    return CR_END_WITH_ERROR; /* seek to required position is not possible */\n  }\n\n  if (lseek (response->fd,\n             (off_t) offset64,\n             SEEK_SET) != (off_t) offset64)\n  {\n    log_state(\"lseek_fail\", pos, max, 5);\n    return CR_END_WITH_ERROR; /* can't seek to required position */\n  }\n#endif\n\n  n = read (response->fd,\n            buf,\n            max);\n\n  if (0 == n)\n  {\n    log_state(\"eof\", pos, max, 6);\n    return CR_END_OF_STREAM;\n  }\n  if (n < 0)\n  {\n    log_state(\"read_error\", pos, max, 7);\n    return CR_END_WITH_ERROR;\n  }\n\n  log_state(\"read_success\", pos, (size_t) n, 8);\n  return n;\n}\n\n```\nThe test code failed to compile, so we could not obtain any output.\n\n</test_code>\n<response format>\nProvide your answer with these fields.\n- explanation: your evaluation of the scenario provided by the agent A.\n- is_report_correct: whether the report is correct or not (true/false)\n</response format>\n<instruction>   \nJudge whether the report is correct or not.\n</instruction>\n",
  "is_report_correct": true,
  "explanation": "Agent A is correct. MISRA C 2023 Rule 17.8 prohibits modifying a function parameter; in the original file_reader the scalar parameter 'max' is assigned to (if (max > SSIZE_MAX) max = SSIZE_MAX;), which is a direct breach of that rule. (The allowance in the rule for modifying the object referred to by a pointer parameter does not apply here because 'max' is a scalar parameter, not a pointed-to object.) Recommended fix: do not assign to the parameter \u2014 introduce a local variable (e.g. size_t to_read = max; if (to_read > SSIZE_MAX) to_read = SSIZE_MAX;) and use that local variable for subsequent calls."
}